# Verifiable Publish and Import

## Encrypting instance archives

`alpine publish <instance name>` creates a `.tar.gz` archive of the filesystem and configurations of an instance. These archives can be used for backup or sharing
purposes.

If instances are published for sharing, it may be desirable to authenticate them using strong cryptography. This allows for verifiable publishing and importing of
instances over untrusted channels such as the internet or shared storage. It also allows for encrypted backups of sensitive instances.

* `alpine publish -p <instance name>` / `alpine publish --passphrase <instance name>`: encrypt and authenticate archive with key derived from a passphrase (interactive prompt)
* `alpine publish -k <instance name>` / `alpine publish --public-key <instance name>`: encrypt and authenticate archive with a public key

To provide this functionality, `macpine` uses [`age`](https://github.com/FiloSottile/age), a modern, efficient, and vetted Go implementation of strong cryptographic
tools which enable authenticated encryption of files. Authenticated encryption requires secrets, either [symmetric](https://en.wikipedia.org/wiki/Symmetric-key_algorithm)
or [asymmetric](https://en.wikipedia.org/wiki/Public-key_cryptography).

### Example: encrypting with a password

If a password is used, the interaction is simple:

```bash
$ alpine list
NAME       STATUS      SSH    PORTS         ARCH        PID       TAGS
devel      Stopped     22                   aarch64     -         daemon,dev
$ alpine publish -p devel                                        # publish instance `devel` with password
Enter passphrase (leave empty to autogenerate a secure one): [return]
age: using autogenerated passphrase "better-avocado-regret-marriage-acoustic-beyond-search-record-drum-shadow"
$ ls devel.tar.gz.age                                            # encrypted archive is created
devel.tar.gz.age
$ alpine delete devel
$ alpine list
NAME       STATUS      SSH    PORTS         ARCH        PID       TAGS
$ alpine import devel.tar.gz.age                                 # import requires the corresponding private key
Enter passphrase: better-avocado-regret-marriage-acoustic-beyond-search-record-drum-shadow
$ alpine list
NAME       STATUS      SSH    PORTS         ARCH        PID       TAGS
devel      Stopped     22                   aarch64     -         daemon,dev
```

### Example: encrypting with public keys

If asymmetric cryptography is desired, `age` can use asymmetric keys in its own format (generated with `age-keygen`). Sharing public keys
in a trusted manner with intended recipients is out of scope for this project, but resources such as [keybase](https://keybase.io) or
other trustworthy exchanges may be useful.

`macpine` uses or generates a public/private key pair `<instance name>_key.pub`/`<instance name>_key`. The latter should be kept private,
and the former can be distributed widely to enable verifiable receipt of encrypted published instances.

```bash
$ alpine list
NAME       STATUS      SSH    PORTS         ARCH        PID       TAGS
devel      Stopped     22                   aarch64     -         daemon,dev
$ alpine publish -k devel                                        # publish instance `devel` and encrypt using public key
$ ls devel.tar.gz.age                                            # encrypted archive is created
devel.tar.gz.age
$ ls -1 devel_key devel_key.pub
devel_key                                                        # keep this file safe!
devel_key.pub
$ alpine delete devel
$ alpine list
NAME       STATUS      SSH    PORTS         ARCH        PID       TAGS
$ alpine import -k devel.tar.gz.age                              # import requires the corresponding private key
$ alpine list
NAME       STATUS      SSH    PORTS         ARCH        PID       TAGS
devel      Stopped     22                   aarch64     -         daemon,dev
```

### Further information

For the details of `age`, such as the [`age` file format](https://github.com/C2SP/C2SP/blob/main/age.md), refer to the documentation of the project.
